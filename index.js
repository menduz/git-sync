"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator.throw(value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
const sa = require('superagent');
const path = require('path');
const fs = require('fs');
var yaml = require('js-yaml');
const cwd = process.cwd();
const glob = require('glob');
const gh = "https://api.github.com/repos/{repo}/contents/{file}";
const syncFiles = glob.sync("**/.git-sync", { cwd: cwd });
const operations = [];
console.log("Found config files: \n\t", syncFiles.join("\n\t"));
syncFiles.forEach(file => {
    var baseDir = path.dirname(file);
    var ast = yaml.safeLoad(fs.readFileSync(file, 'utf8'));
    parseAst(ast, baseDir);
});
if (syncFiles.length == 0) {
    parseAst({}, cwd);
}
function parseAst(ast, baseDir) {
    ast.auth = ast.auth || {
        user: process.env.GIT_SYNC_USER,
        token: process.env.GIT_SYNC_TOKEN
    };
    ast.repository = ast.repository || process.env.GIT_SYNC_REPO;
    ast.pattern = ast.pattern || process.env.GIT_SYNC_PATTERN;
    ast.branch = ast.branch || process.env.GIT_SYNC_BRANCH;
    const syncSubset = glob.sync(baseDir + '/' + (ast.pattern || "*"), { cwd: baseDir, nodir: true });
    syncSubset.forEach(file => operations.push(uploadFile(file, baseDir, ast)));
    console.log("\tFiles:\n\t\t", syncSubset.join("\n\t\t"));
}
function startOperations(operations) {
    return __awaiter(this, void 0, void 0, function* () {
        for (var i in operations) {
            yield operations[i]();
        }
    });
}
startOperations(operations)
    .catch(err => {
    console.error(err.body);
    process.exit(1);
});
function uploadFile(localFile, folder, ast) {
    //localFile = path.relative(localFile, folder)
    localFile = path.normalize(localFile);
    var url = gh.replace('{repo}', ast.repository);
    url = url.replace('{file}', localFile);
    return function () {
        return __awaiter(this, void 0, void 0, function* () {
            console.info(`Uploading ${localFile}`);
            let getResult = null;
            try {
                getResult = yield superagentToPromise(sa
                    .get(url)
                    .auth(ast.auth.user, ast.auth.token));
            }
            catch (e) {
                getResult = e;
            }
            const base64File = new Buffer(fs.readFileSync(path.resolve(folder, localFile))).toString('base64');
            let result = null;
            if (getResult.status == 200) {
                result = yield superagentToPromise(sa
                    .put(url)
                    .auth(ast.auth.user, ast.auth.token)
                    .send({
                    message: ast.message || 'Updated from git-sync script',
                    content: base64File,
                    branch: ast.branch || undefined,
                    sha: getResult.body.sha
                }));
            }
            else if (getResult.status == 404) {
                result = yield superagentToPromise(sa
                    .put(url)
                    .auth(ast.auth.user, ast.auth.token)
                    .send({
                    message: ast.message || 'Updated from git-sync script',
                    content: base64File,
                    branch: ast.branch || undefined
                }));
            }
            else {
                throw new Error("Unknown error Response:" + getResult.status || getResult.toString());
            }
            console.log("\tCommit: #" + result.body.commit.sha);
        });
    };
}
function superagentToPromise(sa) {
    let fulfill = null;
    let raise = null;
    const promise = new Promise((ok, err) => {
        fulfill = ok;
        raise = err;
    });
    sa.set('User-Agent', 'git-pusher/0.0.1');
    sa.end(function (err, res) {
        if (err)
            raise(err);
        else
            fulfill(res);
    });
    return promise;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxNQUFPLEVBQUUsV0FBVyxZQUFZLENBQUMsQ0FBQTtBQUNqQyxNQUFPLElBQUksV0FBVyxNQUFNLENBQUMsQ0FBQTtBQUM3QixNQUFPLEVBQUUsV0FBVyxJQUFJLENBQUMsQ0FBQTtBQUV6QixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDOUIsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFBO0FBQ3pCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtBQUU1QixNQUFNLEVBQUUsR0FBRyxxREFBcUQsQ0FBQTtBQUVoRSxNQUFNLFNBQVMsR0FBYSxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0FBRXBFLE1BQU0sVUFBVSxHQUFHLEVBQUUsQ0FBQztBQUV0QixPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUEwQixFQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQTtBQUUvRCxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUk7SUFDcEIsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUNoQyxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUE7SUFFdEQsUUFBUSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUN6QixDQUFDLENBQUMsQ0FBQztBQUVILEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMxQixRQUFRLENBQUMsRUFBRSxFQUFF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QUUsQ0FBQyxDQUFBO1lBQ3ZGLENBQUM7WUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0RCxDQUFDO0tBQUEsQ0FBQTtBQUNILENBQUM7QUFFRCw2QkFBNkIsRUFBd0I7SUFDbkQsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDO0lBQ25CLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztJQUVqQixNQUFNLE9BQU8sR0FBRyxJQUFJLE9BQU8sQ0FBYyxDQUFDLEVBQUUsRUFBRSxHQUFHO1FBQy9DLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixLQUFLLEdBQUcsR0FBRyxDQUFDO0lBQ2QsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO0lBRXpDLEVBQUUsQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLEVBQUUsR0FBRztRQUN2QixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUM7WUFDTixLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDYixJQUFJO1lBQ0YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2pCLENBQUMsQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDLE9BQU8sQ0FBQztBQUNqQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHNhID0gcmVxdWlyZSgnc3VwZXJhZ2VudCcpXG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMnKVxuXG52YXIgeWFtbCA9IHJlcXVpcmUoJ2pzLXlhbWwnKTtcbmNvbnN0IGN3ZCA9IHByb2Nlc3MuY3dkKClcbmNvbnN0IGdsb2IgPSByZXF1aXJlKCdnbG9iJylcblxuY29uc3QgZ2ggPSBcImh0dHBzOi8vYXBpLmdpdGh1Yi5jb20vcmVwb3Mve3JlcG99L2NvbnRlbnRzL3tmaWxlfVwiXG5cbmNvbnN0IHN5bmNGaWxlczogc3RyaW5nW10gPSBnbG9iLnN5bmMoXCIqKi8uZ2l0LXN5bmNcIiwgeyBjd2Q6IGN3ZCB9KTtcblxuY29uc3Qgb3BlcmF0aW9ucyA9IFtdO1xuXG5jb25zb2xlLmxvZyhcIkZvdW5kIGNvbmZpZyBmaWxlczogXFxuXFx0XCIsIHN5bmNGaWxlcy5qb2luKFwiXFxuXFx0XCIpKVxuXG5zeW5jRmlsZXMuZm9yRWFjaChmaWxlID0+IHtcbiAgdmFyIGJhc2VEaXIgPSBwYXRoLmRpcm5hbWUoZmlsZSlcbiAgdmFyIGFzdCA9IHlhbWwuc2FmZUxvYWQoZnMucmVhZEZpbGVTeW5jKGZpbGUsICd1dGY4JykpXG5cbiAgcGFyc2VBc3QoYXN0LCBiYXNlRGlyKTtcbn0pO1xuXG5pZiAoc3luY0ZpbGVzLmxlbmd0aCA9PSAwKSB7XG4gIHBhcnNlQXN0KHt9LCBjd2QpO1xufVxuXG5mdW5jdGlvbiBwYXJzZUFzdChhc3QsIGJhc2VEaXIpIHtcbiAgYXN0LmF1dGggPSBhc3QuYXV0aCB8fCB7XG4gICAgdXNlcjogcHJvY2Vzcy5lbnYuR0lUX1NZTkNfVVNFUixcbiAgICB0b2tlbjogcHJvY2Vzcy5lbnYuR0lUX1NZTkNfVE9LRU5cbiAgfVxuXG4gIGFzdC5yZXBvc2l0b3J5ID0gYXN0LnJlcG9zaXRvcnkgfHwgcHJvY2Vzcy5lbnYuR0lUX1NZTkNfUkVQT1xuICBhc3QucGF0dGVybiA9IGFzdC5wYXR0ZXJuIHx8IHByb2Nlc3MuZW52LkdJVF9TWU5DX1BBVFRFUk5cbiAgYXN0LmJyYW5jaCA9IGFzdC5icmFuY2ggfHwgcHJvY2Vzcy5lbnYuR0lUX1NZTkNfQlJBTkNIXG5cbiAgY29uc3Qgc3luY1N1YnNldDogc3RyaW5nW10gPSBnbG9iLnN5bmMoYmFzZURpciArICcvJyArIChhc3QucGF0dGVybiB8fCBcIipcIiksIHsgY3dkOiBiYXNlRGlyLCBub2RpcjogdHJ1ZSB9KTtcblxuICBzeW5jU3Vic2V0LmZvckVhY2goZmlsZSA9PiBvcGVyYXRpb25zLnB1c2godXBsb2FkRmlsZShmaWxlLCBiYXNlRGlyLCBhc3QpKSk7XG5cbiAgY29uc29sZS5sb2coXCJcXHRGaWxlczpcXG5cXHRcXHRcIiwgc3luY1N1YnNldC5qb2luKFwiXFxuXFx0XFx0XCIpKVxufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydE9wZXJhdGlvbnMob3BlcmF0aW9ucykge1xuICBmb3IgKHZhciBpIGluIG9wZXJhdGlvbnMpIHtcbiAgICBhd2FpdCBvcGVyYXRpb25zW2ldKCk7XG4gIH1cbn1cblxuc3RhcnRPcGVyYXRpb25zKG9wZXJhdGlvbnMpXG4gIC5jYXRjaChlcnIgPT4ge1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyLmJvZHkpO1xuICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgfSk7XG5cblxuXG5mdW5jdGlvbiB1cGxvYWRGaWxlKGxvY2FsRmlsZSwgZm9sZGVyLCBhc3QpIHtcbiAgLy9sb2NhbEZpbGUgPSBwYXRoLnJlbGF0aXZlKGxvY2FsRmlsZSwgZm9sZGVyKVxuICBsb2NhbEZpbGUgPSBwYXRoLm5vcm1hbGl6ZShsb2NhbEZpbGUpXG5cbiAgdmFyIHVybCA9IGdoLnJlcGxhY2UoJ3tyZXBvfScsIGFzdC5yZXBvc2l0b3J5KVxuXG4gIHVybCA9IHVybC5yZXBsYWNlKCd7ZmlsZX0nLCBsb2NhbEZpbGUpXG5cbiAgcmV0dXJuIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBjb25zb2xlLmluZm8oYFVwbG9hZGluZyAke2xvY2FsRmlsZX1gKTtcblxuICAgIGxldCBnZXRSZXN1bHQ6IHNhLlJlc3BvbnNlID0gbnVsbDtcblxuICAgIHRyeSB7XG4gICAgICBnZXRSZXN1bHQgPSBhd2FpdCBzdXBlcmFnZW50VG9Qcm9taXNlKFxuICAgICAgICBzYVxuICAgICAgICAgIC5nZXQodXJsKVxuICAgICAgICAgIC5hdXRoKGFzdC5hdXRoLnVzZXIsIGFzdC5hdXRoLnRva2VuKVxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBnZXRSZXN1bHQgPSBlO1xuICAgIH1cblxuICAgIGNvbnN0IGJhc2U2NEZpbGUgPSBuZXcgQnVmZmVyKGZzLnJlYWRGaWxlU3luYyhwYXRoLnJlc29sdmUoZm9sZGVyLCBsb2NhbEZpbGUpKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuXG4gICAgbGV0IHJlc3VsdDogc2EuUmVzcG9uc2UgPSBudWxsO1xuICAgIGlmIChnZXRSZXN1bHQuc3RhdHVzID09IDIwMCkge1xuICAgICAgcmVzdWx0ID0gYXdhaXQgc3VwZXJhZ2VudFRvUHJvbWlzZShcbiAgICAgICAgc2FcbiAgICAgICAgICAucHV0KHVybClcbiAgICAgICAgICAuYXV0aChhc3QuYXV0aC51c2VyLCBhc3QuYXV0aC50b2tlbilcbiAgICAgICAgICAuc2VuZCh7XG4gICAgICAgICAgICBtZXNzYWdlOiBhc3QubWVzc2FnZSB8fCAnVXBkYXRlZCBmcm9tIGdpdC1zeW5jIHNjcmlwdCcsXG4gICAgICAgICAgICBjb250ZW50OiBiYXNlNjRGaWxlLFxuICAgICAgICAgICAgYnJhbmNoOiBhc3QuYnJhbmNoIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIHNoYTogZ2V0UmVzdWx0LmJvZHkuc2hhXG4gICAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChnZXRSZXN1bHQuc3RhdHVzID09IDQwNCkge1xuICAgICAgcmVzdWx0ID0gYXdhaXQgc3VwZXJhZ2VudFRvUHJvbWlzZShcbiAgICAgICAgc2FcbiAgICAgICAgICAucHV0KHVybClcbiAgICAgICAgICAuYXV0aChhc3QuYXV0aC51c2VyLCBhc3QuYXV0aC50b2tlbilcbiAgICAgICAgICAuc2VuZCh7XG4gICAgICAgICAgICBtZXNzYWdlOiBhc3QubWVzc2FnZSB8fCAnVXBkYXRlZCBmcm9tIGdpdC1zeW5jIHNjcmlwdCcsXG4gICAgICAgICAgICBjb250ZW50OiBiYXNlNjRGaWxlLFxuICAgICAgICAgICAgYnJhbmNoOiBhc3QuYnJhbmNoIHx8IHVuZGVmaW5lZFxuICAgICAgICAgIH0pXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbmtub3duIGVycm9yIFJlc3BvbnNlOlwiICsgZ2V0UmVzdWx0LnN0YXR1cyB8fCBnZXRSZXN1bHQudG9TdHJpbmcoKSlcbiAgICB9XG5cbiAgICBjb25zb2xlLmxvZyhcIlxcdENvbW1pdDogI1wiICsgcmVzdWx0LmJvZHkuY29tbWl0LnNoYSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gc3VwZXJhZ2VudFRvUHJvbWlzZShzYTogc2EuU3VwZXJBZ2VudFJlcXVlc3QpIHtcbiAgbGV0IGZ1bGZpbGwgPSBudWxsO1xuICBsZXQgcmFpc2UgPSBudWxsO1xuXG4gIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZTxzYS5SZXNwb25zZT4oKG9rLCBlcnIpID0+IHtcbiAgICBmdWxmaWxsID0gb2s7XG4gICAgcmFpc2UgPSBlcnI7XG4gIH0pO1xuXG4gIHNhLnNldCgnVXNlci1BZ2VudCcsICdnaXQtcHVzaGVyLzAuMC4xJyk7XG5cbiAgc2EuZW5kKGZ1bmN0aW9uIChlcnIsIHJlcykge1xuICAgIGlmIChlcnIpXG4gICAgICByYWlzZShlcnIpO1xuICAgIGVsc2VcbiAgICAgIGZ1bGZpbGwocmVzKTtcbiAgfSk7XG5cbiAgcmV0dXJuIHByb21pc2U7XG59Il19