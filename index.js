"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator.throw(value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
const sa = require('superagent');
const path = require('path');
const fs = require('fs');
var yaml = require('js-yaml');
const cwd = process.cwd();
const glob = require('glob');
const gh = "https://api.github.com/repos/{repo}/contents/{file}";
const syncFiles = glob.sync("**/.git-sync", { cwd: cwd });
const operations = [];
console.log("Found config files: \n\t", syncFiles.join("\n\t"));
syncFiles.forEach(file => {
    var baseDir = path.dirname(file);
    var ast = yaml.safeLoad(fs.readFileSync(file, 'utf8'));
    ast.auth = ast.auth || {
        user: process.env.GIT_SYNC_USER,
        token: process.env.GIT_SYNC_TOKEN
    };
    ast.repository = ast.repository || process.env.GIT_SYNC_REPO;
    ast.pattern = ast.pattern || process.env.GIT_SYNC_PATTERN;
    const syncSubset = glob.sync(baseDir + '/' + (ast.pattern || "*"), { cwd: baseDir, nodir: true });
    syncSubset.forEach(file => operations.push(uploadFile(file, baseDir, ast)));
    console.log("\tFiles:\n\t\t", syncSubset.join("\n\t\t"));
});
function startOperations(operations) {
    return __awaiter(this, void 0, void 0, function* () {
        for (var i in operations) {
            yield operations[i]();
        }
    });
}
startOperations(operations)
    .catch(err => {
    console.log(err);
    console.dir(err);
});
function uploadFile(localFile, folder, ast) {
    //localFile = path.relative(localFile, folder)
    localFile = path.normalize(localFile);
    var url = gh.replace('{repo}', ast.repository);
    url = url.replace('{file}', localFile);
    return function () {
        return __awaiter(this, void 0, void 0, function* () {
            console.info(`Uploading ${localFile}`);
            let getResult = null;
            try {
                getResult = yield superagentToPromise(sa
                    .get(url)
                    .auth(ast.auth.user, ast.auth.token));
            }
            catch (e) {
                getResult = e;
            }
            const base64File = new Buffer(fs.readFileSync(path.resolve(folder, localFile))).toString('base64');
            let result = null;
            if (getResult.status == 200) {
                result = yield superagentToPromise(sa
                    .put(url)
                    .auth(ast.auth.user, ast.auth.token)
                    .send({
                    message: ast.message || 'Updated from git-sync script',
                    content: base64File,
                    branch: ast.branch || undefined,
                    sha: getResult.body.sha
                }));
            }
            else if (getResult.status == 404) {
                result = yield superagentToPromise(sa
                    .put(url)
                    .auth(ast.auth.user, ast.auth.token)
                    .send({
                    message: ast.message || 'Updated from git-sync script',
                    content: base64File,
                    branch: ast.branch || undefined
                }));
            }
            else {
                throw new Error("Unknown error Response:" + getResult.status || getResult.toString());
            }
            console.log("\tCommit: #" + result.body.commit.sha);
        });
    };
}
function superagentToPromise(sa) {
    let fulfill = null;
    let raise = null;
    const promise = new Promise((ok, err) => {
        fulfill = ok;
        raise = err;
    });
    sa.set('User-Agent', 'git-pusher/0.0.1');
    sa.end(function (err, res) {
        if (err)
            raise(err);
        else
            fulfill(res);
    });
    return promise;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxNQUFPLEVBQUUsV0FBVyxZQUFZLENBQUMsQ0FBQTtBQUNqQyxNQUFPLElBQUksV0FBVyxNQUFNLENBQUMsQ0FBQTtBQUM3QixNQUFPLEVBQUUsV0FBVyxJQUFJLENBQUMsQ0FBQTtBQUV6QixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDOUIsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFBO0FBQ3pCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtBQUU1QixNQUFNLEVBQUUsR0FBRyxxREFBcUQsQ0FBQTtBQUVoRSxNQUFNLFNBQVMsR0FBYSxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0FBRXBFLE1BQU0sVUFBVSxHQUFHLEVBQUUsQ0FBQztBQUV0QixPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUEwQixFQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQTtBQUUvRCxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUk7SUFDcEIsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUNoQyxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUE7SUFFdEQsR0FBRyxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxJQUFJO1FBQ3JCLElBQUksRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWE7UUFDL0IsS0FBSyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYztLQUNsQyxDQUFBO0lBRUQsR0FB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T0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNiLEtBQUssR0FBRyxHQUFHLENBQUM7SUFDZCxDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLGtCQUFrQixDQUFDLENBQUM7SUFFekMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEdBQUcsRUFBRSxHQUFHO1FBQ3ZCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQztZQUNOLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNiLElBQUk7WUFDRixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDakIsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLENBQUMsT0FBTyxDQUFDO0FBQ2pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgc2EgPSByZXF1aXJlKCdzdXBlcmFnZW50JylcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcycpXG5cbnZhciB5YW1sID0gcmVxdWlyZSgnanMteWFtbCcpO1xuY29uc3QgY3dkID0gcHJvY2Vzcy5jd2QoKVxuY29uc3QgZ2xvYiA9IHJlcXVpcmUoJ2dsb2InKVxuXG5jb25zdCBnaCA9IFwiaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9yZXBvcy97cmVwb30vY29udGVudHMve2ZpbGV9XCJcblxuY29uc3Qgc3luY0ZpbGVzOiBzdHJpbmdbXSA9IGdsb2Iuc3luYyhcIioqLy5naXQtc3luY1wiLCB7IGN3ZDogY3dkIH0pO1xuXG5jb25zdCBvcGVyYXRpb25zID0gW107XG5cbmNvbnNvbGUubG9nKFwiRm91bmQgY29uZmlnIGZpbGVzOiBcXG5cXHRcIiwgc3luY0ZpbGVzLmpvaW4oXCJcXG5cXHRcIikpXG5cbnN5bmNGaWxlcy5mb3JFYWNoKGZpbGUgPT4ge1xuICB2YXIgYmFzZURpciA9IHBhdGguZGlybmFtZShmaWxlKVxuICB2YXIgYXN0ID0geWFtbC5zYWZlTG9hZChmcy5yZWFkRmlsZVN5bmMoZmlsZSwgJ3V0ZjgnKSlcblxuICBhc3QuYXV0aCA9IGFzdC5hdXRoIHx8IHtcbiAgICB1c2VyOiBwcm9jZXNzLmVudi5HSVRfU1lOQ19VU0VSLFxuICAgIHRva2VuOiBwcm9jZXNzLmVudi5HSVRfU1lOQ19UT0tFTlxuICB9XG5cbiAgYXN0LnJlcG9zaXRvcnkgPSBhc3QucmVwb3NpdG9yeSB8fCBwcm9jZXNzLmVudi5HSVRfU1lOQ19SRVBPXG4gIGFzdC5wYXR0ZXJuID0gYXN0LnBhdHRlcm4gfHwgcHJvY2Vzcy5lbnYuR0lUX1NZTkNfUEFUVEVSTlxuXG4gIGNvbnN0IHN5bmNTdWJzZXQ6IHN0cmluZ1tdID0gZ2xvYi5zeW5jKGJhc2VEaXIgKyAnLycgKyAoYXN0LnBhdHRlcm4gfHwgXCIqXCIpLCB7IGN3ZDogYmFzZURpciwgbm9kaXI6IHRydWUgfSk7XG5cbiAgc3luY1N1YnNldC5mb3JFYWNoKGZpbGUgPT4gb3BlcmF0aW9ucy5wdXNoKHVwbG9hZEZpbGUoZmlsZSwgYmFzZURpciwgYXN0KSkpO1xuXG4gIGNvbnNvbGUubG9nKFwiXFx0RmlsZXM6XFxuXFx0XFx0XCIsIHN5bmNTdWJzZXQuam9pbihcIlxcblxcdFxcdFwiKSlcbn0pO1xuXG5hc3luYyBmdW5jdGlvbiBzdGFydE9wZXJhdGlvbnMob3BlcmF0aW9ucykge1xuICBmb3IgKHZhciBpIGluIG9wZXJhdGlvbnMpIHtcbiAgICBhd2FpdCBvcGVyYXRpb25zW2ldKCk7XG4gIH1cbn1cblxuc3RhcnRPcGVyYXRpb25zKG9wZXJhdGlvbnMpXG4gIC5jYXRjaChlcnIgPT4ge1xuICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgY29uc29sZS5kaXIoZXJyKTtcbiAgfSk7XG5cblxuXG5mdW5jdGlvbiB1cGxvYWRGaWxlKGxvY2FsRmlsZSwgZm9sZGVyLCBhc3QpIHtcbiAgLy9sb2NhbEZpbGUgPSBwYXRoLnJlbGF0aXZlKGxvY2FsRmlsZSwgZm9sZGVyKVxuICBsb2NhbEZpbGUgPSBwYXRoLm5vcm1hbGl6ZShsb2NhbEZpbGUpXG5cbiAgdmFyIHVybCA9IGdoLnJlcGxhY2UoJ3tyZXBvfScsIGFzdC5yZXBvc2l0b3J5KVxuXG4gIHVybCA9IHVybC5yZXBsYWNlKCd7ZmlsZX0nLCBsb2NhbEZpbGUpXG5cbiAgcmV0dXJuIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBjb25zb2xlLmluZm8oYFVwbG9hZGluZyAke2xvY2FsRmlsZX1gKTtcblxuICAgIGxldCBnZXRSZXN1bHQ6IHNhLlJlc3BvbnNlID0gbnVsbDtcblxuICAgIHRyeSB7XG4gICAgICBnZXRSZXN1bHQgPSBhd2FpdCBzdXBlcmFnZW50VG9Qcm9taXNlKFxuICAgICAgICBzYVxuICAgICAgICAgIC5nZXQodXJsKVxuICAgICAgICAgIC5hdXRoKGFzdC5hdXRoLnVzZXIsIGFzdC5hdXRoLnRva2VuKVxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBnZXRSZXN1bHQgPSBlO1xuICAgIH1cblxuICAgIGNvbnN0IGJhc2U2NEZpbGUgPSBuZXcgQnVmZmVyKGZzLnJlYWRGaWxlU3luYyhwYXRoLnJlc29sdmUoZm9sZGVyLCBsb2NhbEZpbGUpKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICAgIGxldCByZXN1bHQ6IHNhLlJlc3BvbnNlID0gbnVsbDtcbiAgICBpZiAoZ2V0UmVzdWx0LnN0YXR1cyA9PSAyMDApIHtcbiAgICAgIHJlc3VsdCA9IGF3YWl0IHN1cGVyYWdlbnRUb1Byb21pc2UoXG4gICAgICAgIHNhXG4gICAgICAgICAgLnB1dCh1cmwpXG4gICAgICAgICAgLmF1dGgoYXN0LmF1dGgudXNlciwgYXN0LmF1dGgudG9rZW4pXG4gICAgICAgICAgLnNlbmQoe1xuICAgICAgICAgICAgbWVzc2FnZTogYXN0Lm1lc3NhZ2UgfHwgJ1VwZGF0ZWQgZnJvbSBnaXQtc3luYyBzY3JpcHQnLFxuICAgICAgICAgICAgY29udGVudDogYmFzZTY0RmlsZSxcbiAgICAgICAgICAgIGJyYW5jaDogYXN0LmJyYW5jaCB8fCB1bmRlZmluZWQsXG4gICAgICAgICAgICBzaGE6IGdldFJlc3VsdC5ib2R5LnNoYVxuICAgICAgICAgIH0pXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAoZ2V0UmVzdWx0LnN0YXR1cyA9PSA0MDQpIHtcbiAgICAgIHJlc3VsdCA9IGF3YWl0IHN1cGVyYWdlbnRUb1Byb21pc2UoXG4gICAgICAgIHNhXG4gICAgICAgICAgLnB1dCh1cmwpXG4gICAgICAgICAgLmF1dGgoYXN0LmF1dGgudXNlciwgYXN0LmF1dGgudG9rZW4pXG4gICAgICAgICAgLnNlbmQoe1xuICAgICAgICAgICAgbWVzc2FnZTogYXN0Lm1lc3NhZ2UgfHwgJ1VwZGF0ZWQgZnJvbSBnaXQtc3luYyBzY3JpcHQnLFxuICAgICAgICAgICAgY29udGVudDogYmFzZTY0RmlsZSxcbiAgICAgICAgICAgIGJyYW5jaDogYXN0LmJyYW5jaCB8fCB1bmRlZmluZWRcbiAgICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVW5rbm93biBlcnJvciBSZXNwb25zZTpcIiArIGdldFJlc3VsdC5zdGF0dXMgfHwgZ2V0UmVzdWx0LnRvU3RyaW5nKCkpXG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coXCJcXHRDb21taXQ6ICNcIiArIHJlc3VsdC5ib2R5LmNvbW1pdC5zaGEpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHN1cGVyYWdlbnRUb1Byb21pc2Uoc2E6IHNhLlN1cGVyQWdlbnRSZXF1ZXN0KSB7XG4gIGxldCBmdWxmaWxsID0gbnVsbDtcbiAgbGV0IHJhaXNlID0gbnVsbDtcblxuICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2U8c2EuUmVzcG9uc2U+KChvaywgZXJyKSA9PiB7XG4gICAgZnVsZmlsbCA9IG9rO1xuICAgIHJhaXNlID0gZXJyO1xuICB9KTtcblxuICBzYS5zZXQoJ1VzZXItQWdlbnQnLCAnZ2l0LXB1c2hlci8wLjAuMScpO1xuXG4gIHNhLmVuZChmdW5jdGlvbiAoZXJyLCByZXMpIHtcbiAgICBpZiAoZXJyKVxuICAgICAgcmFpc2UoZXJyKTtcbiAgICBlbHNlXG4gICAgICBmdWxmaWxsKHJlcyk7XG4gIH0pO1xuXG4gIHJldHVybiBwcm9taXNlO1xufSJdfQ==